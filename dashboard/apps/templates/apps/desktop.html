<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop</title>
    <style>
        body {
            background: #2c3e50;
            color: white;
            font-family: Arial, sans-serif;
            background: url('/static/images/fond.jpg');
        }
        .toolbar {
            background-color: blanchedalmond;
        }
        .toolbar button {
            background-color: #1a1a2e;
            color: white;
            margin: 5px;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        .desktop {
            position: relative;
            width: 100%;
            height: 90vh;
            overflow: hidden;
        }
        .tool-box {
            position: absolute;
            width: 150px;
            height: 100px;
            border: 2px solid white;
            padding: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-box img {
            width: 50px;
            height: 50px;
        }
        .context-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000;
        }
        .context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .context-menu ul li {
            padding: 8px 12px;
            cursor: pointer;
        }
        .context-menu ul li:hover {
            background-color: #ededed;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button onclick="createTool('Terminal', 'https://via.placeholder.com/50', '#000000', '/apps/terminal', 450, 350)">Terminal</button>
        <button onclick="createTool('Snake', 'https://via.placeholder.com/50', '#164b13', '/apps/snake', 200, 350)">Snake</button>
        <button onclick="createTool('Agenda', 'https://via.placeholder.com/50', '#af77b7', '/apps/agenda', 200, 350)">Agenda</button>
        <button onclick="createTool('Crypto', 'https://via.placeholder.com/50', '#c4c648', '/apps/crypto', 200, 350)">Crypto</button>
        <button onclick="createTool('Files Explorer', 'https://via.placeholder.com/50', '#606cd3', '/apps/explorer', 200, 350)">Files Explorer</button>
    </div>

    {% if tools %}
    <div class="desktop" id="desktop">
        {% for tool in tools %}
        <div class="tool-box" id="tool-{{ tool.id }}" style="background-color: {{ tool.color }}; height: {{ tool.height }}px; width: {{ tool.width }}px;">
            <iframe src="{{ tool.url }}" width="100%" height="100%"></iframe> 
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="context-menu" id="context-menu">
        <ul>
            <li onclick="closeToolBox()" style="color: black;">Fermer</li>
        </ul>
    </div>

    <script>
        function makeDraggable(element) {
            let isDragging = false;
            let offsetX, offsetY;

            element.addEventListener("mousedown", function(e) {
                isDragging = true;
                offsetX = e.clientX - element.offsetLeft;
                offsetY = e.clientY - element.offsetTop;
                element.style.cursor = "grabbing";
            });

            document.addEventListener("mousemove", function(e) {
                if (isDragging) {
                    element.style.left = e.clientX - offsetX + "px";
                    element.style.top = e.clientY - offsetY + "px";
                }
            });

            document.addEventListener("mouseup", function() {
                isDragging = false;
                element.style.cursor = "grab";
            });
        }

        document.querySelectorAll(".tool-box").forEach(makeDraggable);

        function createTool(name, icon_url, color, url, height, width) {
            fetch("{% url 'create_tool' %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: new URLSearchParams({
                    name: name,
                    icon_url: icon_url,
                    color: color,
                    url: url,
                    height: height,
                    width: width
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("reponse recu", data);
                if (data.error) return alert(data.error);

                const toolBox = document.createElement("div");
                toolBox.className = "tool-box";
                toolBox.id = "tool-" + data.id;
                toolBox.style.backgroundColor = data.color;
                toolBox.style.top = "100px";
                toolBox.style.left = "100px";
                toolBox.style.height = data.height + "px";
                toolBox.style.width = data.width + "px";
                toolBox.innerHTML = `
                    <iframe src="${data.url}" width="100%" height="100%"></iframe>
                `;

                document.getElementById("desktop").appendChild(toolBox);
                makeDraggable(toolBox);
                addContextMenu(toolBox);
            });
        }

        function addContextMenu(element) {
            element.addEventListener("contextmenu", function(e) {
                e.preventDefault();
                const contextMenu = document.getElementById("context-menu");
                contextMenu.style.display = "block";
                contextMenu.style.left = e.pageX + "px";
                contextMenu.style.top = e.pageY + "px";
                contextMenu.dataset.target = element.id;
            });
        }

        document.addEventListener("click", function() {
            document.getElementById("context-menu").style.display = "none";
        });

        function closeToolBox() {
            const contextMenu = document.getElementById("context-menu");
            const targetId = contextMenu.dataset.target;
            const targetElement = document.getElementById(targetId);

            fetch(`/delete_tool/${targetId.split('-')[1]}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    targetElement.remove();
                } else {
                    alert("Erreur lors de la suppression de l'outil.");
                }
            });
        }

        document.querySelectorAll(".tool-box").forEach(addContextMenu);
    </script>
</body>
</html>